<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Angol Nyelvtanul√≥ Alkalmaz√°s</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4CAF50">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4CAF50;
            --primary-hover: #43a047;
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --card-bg: #ffffff;
            --text-color: #333333;
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
            --radius: 16px;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-gradient);
            display: flex;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px 0; /* Hely hagy√°sa a sz√©leken */
            box-sizing: border-box;
            color: var(--text-color);
        }
        .container {
            background: var(--card-bg);
            padding: 2.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            max-width: 600px;
            width: 90%;
            text-align: center;
            margin: auto; /* Biztons√°gos k√∂z√©pre igaz√≠t√°s */
            transition: transform 0.3s ease;
        }
        h1 { font-weight: 600; color: var(--primary-color); margin-bottom: 1.5rem; }
        h2 { font-weight: 500; color: #444; margin-bottom: 1rem; }
        h3 { font-weight: 500; color: #555; margin-top: 2rem; }
        
        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 14px 24px;
            margin: 8px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s ease;
            width: 100%;
            max-width: 300px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn:hover { 
            background-color: var(--primary-hover); 
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .btn:active { transform: translateY(0); }
        
        .btn-option {
            background-color: white;
            color: #333;
            border: 2px solid #e0e0e0;
            box-shadow: none;
        }
        .btn-option:hover { 
            background-color: #f0fcf1; 
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        .hidden { display: none; }
        
        /* Anim√°ci√≥k */
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        #feedback { margin-top: 15px; font-weight: bold; min-height: 24px; }
        .correct { color: green; }
        .wrong { color: red; }
        .progress { margin-top: 10px; color: #666; font-size: 0.9em; }
        .reading-text {
            font-size: 1.15em;
            line-height: 1.6;
            text-align: left;
            margin: 20px 0;
            padding: 20px;
            background: #f1f8e9;
            border-radius: 12px;
            border-left: 5px solid var(--primary-color);
            color: #333;
        }
        .timer-bar-container { width: 100%; background-color: #e0e0e0; border-radius: 5px; height: 12px; margin-top: 15px; overflow: hidden; }
        .timer-bar { height: 100%; background-color: var(--primary-color); width: 0%; transition: width 0.1s linear; }
        .reading-controls { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .vocab-table { width: 100%; border-collapse: collapse; margin-top: 10px; text-align: left; font-size: 0.9em; }
        .vocab-table th, .vocab-table td { padding: 8px; border-bottom: 1px solid #eee; }
        .vocab-table th { background-color: #f9f9f9; color: #444; font-weight: 600; }
        .vocab-level-header { background-color: var(--primary-color); color: white; padding: 10px 15px; margin-top: 20px; border-radius: 8px; font-weight: 600; text-align: left; }
        .sentence-area {
            min-height: 60px;
            border: 2px dashed #bdbdbd;
            border-radius: 12px;
            padding: 15px;
            margin: 20px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            background-color: #fff;
            align-items: center;
        }
        .word-pool {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 25px;
            min-height: 50px;
        }
        .word-chip {
            background-color: #e3f2fd;
            color: #1565c0;
            border: none;
            border-radius: 20px;
            padding: 10px 18px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            user-select: none;
            transition: transform 0.1s, background-color 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .word-chip:hover {
            background-color: #bbdefb; 
            transform: translateY(-2px);
        }
        .word-chip:active {
            transform: translateY(0);
        }
        
        /* Grid a gomboknak */
        .grid-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .grid-buttons .btn {
            width: 100%;
            margin: 0;
            max-width: none;
        }
    </style>
</head>
<body>

    <!-- F≈ëmen√º -->
    <div class="container fade-in" id="menu">
        <h1>Angol Nyelvtanul√≥ Program</h1>
        <p>V√°lassz szintet a kezd√©shez:</p>
        <div style="margin-bottom: 15px;">
            <label style="font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <input type="checkbox" id="hard-mode" style="width: 18px; height: 18px; accent-color: var(--primary-color);"> Neh√©z m√≥d (10 mp) üî•
            </label>
            <div style="margin-top: 10px;">
                <label for="session-duration" style="font-size: 16px; color: #444;">Id≈ëkorl√°t:</label>
                <select id="session-duration" class="btn-option" style="width: auto; padding: 8px; margin-left: 10px; display: inline-block; border-radius: 8px;">
                    <option value="0" selected>Nincs (V√©gtelen)</option>
                    <option value="60">1 perc</option>
                    <option value="300">5 perc</option>
                    <option value="600">10 perc</option>
                </select>
            </div>
        </div>
        
        <div class="grid-buttons">
            <button class="btn" onclick="startLevel('A1')">A1 - Kezd≈ë</button>
            <button class="btn" onclick="startLevel('A2')">A2 - Alapfok</button>
            <button class="btn" onclick="startLevel('B1')">B1 - K√∂z√©p 1</button>
            <button class="btn" onclick="startLevel('B2')">B2 - K√∂z√©p 2</button>
            <button class="btn" onclick="startLevel('C1')">C1 - Fels≈ë 1</button>
            <button class="btn" onclick="startLevel('C2')">C2 - Fels≈ë 2</button>
        </div>

        <h3>üìñ 1 Perces Olvas√°s</h3>
        <div class="grid-buttons">
            <button class="btn" onclick="startReading('A1')">A1</button>
            <button class="btn" onclick="startReading('A2')">A2</button>
            <button class="btn" onclick="startReading('B1')">B1</button>
            <button class="btn" onclick="startReading('B2')">B2</button>
            <button class="btn" onclick="startReading('C1')">C1</button>
            <button class="btn" onclick="startReading('C2')">C2</button>
        </div>

        <h3>üß© Mondat√©p√≠t≈ë</h3>
        <div class="grid-buttons">
            <button class="btn" onclick="startSentenceBuilder('A1')">A1</button>
            <button class="btn" onclick="startSentenceBuilder('A2')">A2</button>
            <button class="btn" onclick="startSentenceBuilder('B1')">B1</button>
            <button class="btn" onclick="startSentenceBuilder('B2')">B2</button>
            <button class="btn" onclick="startSentenceBuilder('C1')">C1</button>
            <button class="btn" onclick="startSentenceBuilder('C2')">C2</button>
        </div>

        <div style="margin-top: 20px;">
            <button class="btn" style="background-color: #0288d1;" onclick="showVocabulary()">üìö Sz√≥kincs T√°r</button>
            <button class="btn" id="installBtn" style="display:none; background-color: #FF5722;">üì≤ App Telep√≠t√©se</button>
        </div>

        <div id="stats" style="margin-top: 25px; text-align: left; border-top: 1px solid #eee; padding-top: 15px;">
            <h3 style="font-size: 1.1em; margin-bottom: 10px; color: #444;">üèÜ Eredm√©nyeim</h3>
            <ul id="stats-list" style="list-style: none; padding: 0; font-size: 0.95em; color: #666;">
                <li>M√©g nincs mentett eredm√©ny.</li>
            </ul>
            <button onclick="clearStats()" style="background: none; border: none; color: #999; font-size: 0.8em; cursor: pointer; margin-top: 5px; text-decoration: underline;">Statisztika t√∂rl√©se</button>
        </div>

        <footer style="margin-top: 25px; font-size: 0.85em; color: #888; border-top: 1px solid #eee; padding-top: 15px;">
            <p style="margin: 0 0 5px 0;">K√©sz√≠tette: Dr. P√©terfi Zolt√°n</p>
            <p style="margin: 0;">Verzi√≥: 1.3.0</p>
        </footer>
    </div>

    <!-- Kv√≠z fel√ºlet -->
    <div class="container hidden" id="quiz">
        <h2 id="level-title">Szint</h2>
        <p class="progress">K√©rd√©s: <span id="q-num">1</span> | Pontsz√°m: <span id="score-display">0</span> | Id≈ë: <span id="timer">30</span>mp <span id="global-timer-wrapper" class="hidden">| H√°tral√©v≈ë: <span id="global-timer">00:00</span></span></p>
        <div style="margin: 30px 0; display: flex; justify-content: center; align-items: center; gap: 10px;">
            <h3 id="question-text" style="margin: 0;">K√©rd√©s helye</h3>
            <button onclick="speakCurrentQuestion()" style="background: none; border: none; cursor: pointer; font-size: 1.5em;" title="Kiejt√©s">üîä</button>
        </div>
        <div id="options-container"></div>
        <p id="feedback"></p>
        <button class="btn hidden" id="next-btn" onclick="nextQuestion()">K√∂vetkez≈ë</button>
        <button class="btn" style="background-color: #777; margin-top: 20px;" onclick="showMenu()">Vissza a men√ºbe</button>
    </div>

    <!-- Olvas√°s fel√ºlet -->
    <div class="container hidden" id="reading-practice">
        <h2 id="reading-level-title">Olvas√°s</h2>
        <p style="color: #666; font-size: 0.9em;">Olvasd a sz√∂veget hangosan. A cs√≠k mutatja az aj√°nlott 1 perces temp√≥t.</p>
        
        <div id="reading-content" class="reading-text"></div>
        
        <div class="timer-bar-container">
            <div id="reading-progress" class="timer-bar"></div>
        </div>
        
        <div class="reading-controls">
            <button class="btn" onclick="speakReadingText()" style="background-color: #FF9800;">üîä Felolvas√°s</button>
            <button class="btn" id="pronunciation-btn" onclick="togglePronunciation()" style="background-color: #9C27B0;">üé§ Kiejt√©s</button>
            <button class="btn" id="start-reading-btn" onclick="startReadingTimer()">‚è±Ô∏è Ind√≠t√°s</button>
            <button class="btn hidden" id="new-text-btn" onclick="loadNewReadingText()">üîÑ √öj sz√∂veg</button>
        </div>
        <div id="pronunciation-feedback" style="margin-top: 15px; padding: 10px; border: 1px solid #eee; border-radius: 5px; min-height: 20px; font-size: 0.9em; background-color: #fafafa; display: none;"></div>
        <button class="btn" style="background-color: #777; margin-top: 20px;" onclick="showMenu()">Vissza a men√ºbe</button>
    </div>

    <!-- Mondat√©p√≠t≈ë fel√ºlet -->
    <div class="container hidden" id="sentence-builder">
        <h2 id="sb-level-title">Mondat√©p√≠t≈ë</h2>
        <p style="color: #666; font-size: 0.9em;">Kattints a szavakra a helyes sorrend √∂ssze√°ll√≠t√°s√°hoz!</p>
        
        <div id="sb-target" class="sentence-area"></div>
        <div id="sb-pool" class="word-pool"></div>
        
        <p id="sb-feedback"></p>

        <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 15px;">
            <button class="btn" onclick="checkSentenceOrder()" style="background-color: #4CAF50; width: auto; flex: 1;">Ellen≈ërz√©s</button>
            <button class="btn" onclick="resetSentenceTask()" style="background-color: #FF9800; width: auto; flex: 1;">√öjra</button>
            <button class="btn" onclick="showSentenceSolution()" style="background-color: #2196F3; width: auto; flex: 1;">Megold√°s</button>
            <button class="btn" onclick="speakSentence()" style="background-color: #9C27B0; width: auto; flex: 1;" title="Kiejt√©s">üîä</button>
        </div>
        
        <button class="btn hidden" id="sb-next-btn" onclick="nextSentenceTask()">K√∂vetkez≈ë</button>
        <button class="btn" style="background-color: #777; margin-top: 20px;" onclick="showMenu()">Vissza a men√ºbe</button>
    </div>

    <!-- Sz√≥kincs fel√ºlet -->
    <div class="container hidden" id="vocabulary-view" style="max-width: 800px;">
        <h2>Sz√≥kincs √©s Nyelvtan</h2>
        <div id="vocab-content" style="max-height: 60vh; overflow-y: auto; padding-right: 5px;"></div>
        <button class="btn" style="background-color: #777; margin-top: 20px;" onclick="showMenu()">Vissza a men√ºbe</button>
    </div>

    <script src="./A1.js"></script>
    <script src="./A2.js"></script>
    <script src="./B1.js"></script>
    <script src="./B2.js"></script>
    <script src="./C1.js"></script>
    <script src="./C2.js"></script>
    <script>
        // Adatb√°zis a szintekhez (b≈ëv√≠thet≈ë)
        const database = {
            ...questions,
            ...questionsA2,
            ...questionsB1,
            ...questionsB2,
            ...questionsC1,
            ...questionsC2
        };

        const readingDatabase = {
            'A1': [
                { text: "My name is Peter. I am from Hungary. I live in a small house with my family. I have a dog and a cat. Every day, I go to school. I like learning English. In the afternoon, I play football with my friends. My favorite food is pizza. I usually go to bed at nine o'clock.", translation: "A nevem P√©ter. Magyarorsz√°gr√≥l sz√°rmazom. Egy kis h√°zban √©lek a csal√°dommal. Van egy kuty√°m √©s egy macsk√°m. Minden nap iskol√°ba megyek. Szeretek angolul tanulni. D√©lut√°n focizom a bar√°taimmal. A kedvenc √©telem a pizza. √Åltal√°ban kilenc √≥rakor fekszem le." },
                { text: "This is my room. It is small but nice. There is a bed, a desk, and a chair. I have many books on the shelf. I like reading in the evening. My computer is on the desk. I use it to do my homework. The walls are blue. I love my room because it is quiet.", translation: "Ez a szob√°m. Kicsi, de kedves. Van benne egy √°gy, egy √≠r√≥asztal √©s egy sz√©k. Sok k√∂nyvem van a polcon. Szeretek este olvasni. A sz√°m√≠t√≥g√©pem az √≠r√≥asztalon van. A h√°zi feladatom elk√©sz√≠t√©s√©re haszn√°lom. A falak k√©kek. Szeretem a szob√°mat, mert csendes." },
                { text: "I go shopping on Saturdays. I go to the supermarket with my mother. We buy bread, milk, and fruit. I like apples and bananas. Sometimes we buy chocolate too. The supermarket is big. There are many people there. After shopping, we go home and cook lunch.", translation: "Szombatonk√©nt v√°s√°rolni megyek. Az √©desany√°mmal megyek a szupermarketbe. Kenyeret, tejet √©s gy√ºm√∂lcs√∂t vesz√ºnk. Szeretem az alm√°t √©s a ban√°nt. N√©ha csokol√°d√©t is vesz√ºnk. A szupermarket nagy. Sok ember van ott. V√°s√°rl√°s ut√°n hazamegy√ºnk √©s eb√©det f≈ëz√ºnk." },
                { text: "I love playing games with my friends. We usually play football in the park on Sundays. When it rains, we stay inside and play video games. My favorite game is about building cities. It is very fun and exciting. Sometimes we play board games too. I like winning, but having fun is more important.", translation: "Szeretek j√°tszani a bar√°taimmal. Vas√°rnaponk√©nt √°ltal√°ban focizunk a parkban. Ha esik az es≈ë, bent maradunk √©s videoj√°t√©kokkal j√°tszunk. A kedvenc j√°t√©kom v√°rosok √©p√≠t√©s√©r≈ël sz√≥l. Nagyon sz√≥rakoztat√≥ √©s izgalmas. N√©ha t√°rsasj√°t√©kokkal is j√°tszunk. Szeretek nyerni, de a sz√≥rakoz√°s fontosabb." }
            ],
            'A2': [
                { text: "Last summer, I went to Lake Balaton with my friends. We travelled by train. The weather was very hot and sunny. We swam in the lake every day and ate l√°ngos. In the evenings, we walked on the beach and talked. It was a fantastic holiday. I want to go back next year.", translation: "Tavaly ny√°ron a Balatonn√°l voltam a bar√°taimmal. Vonattal utaztunk. Az id≈ë nagyon meleg √©s napos volt. Minden nap √∫sztunk a t√≥ban √©s l√°ngost ett√ºnk. Est√©nk√©nt a parton s√©t√°ltunk √©s besz√©lgett√ºnk. Fantasztikus nyaral√°s volt. J√∂v≈ëre vissza akarok menni." },
                { text: "I work in an office in the city center. I usually wake up at six o'clock. I take the bus to work. It takes about thirty minutes. My job is interesting but sometimes stressful. I have to answer many emails and talk to clients. At lunch, I usually eat a sandwich in the park.", translation: "Egy irod√°ban dolgozom a belv√°rosban. √Åltal√°ban hat √≥rakor √©bredek. Busszal megyek dolgozni. K√∂r√ºlbel√ºl harminc percig tart. A munk√°m √©rdekes, de n√©ha stresszes. Sok e-mailre kell v√°laszolnom √©s √ºgyfelekkel besz√©lnem. Eb√©did≈ëben √°ltal√°ban szendvicset eszem a parkban." },
                { text: "My favorite hobby is cooking. I learned to cook from my grandmother. She makes the best soup in the world. I like trying new recipes from different countries. Last week, I made Italian pasta. My family loved it. Cooking relaxes me after a long day at work.", translation: "A kedvenc hobbim a f≈ëz√©s. A nagymam√°mt√≥l tanultam f≈ëzni. ≈ê k√©sz√≠ti a vil√°g legjobb leves√©t. Szeretek √∫j recepteket kipr√≥b√°lni k√ºl√∂nb√∂z≈ë orsz√°gokb√≥l. M√∫lt h√©ten olasz t√©szt√°t k√©sz√≠tettem. A csal√°dom im√°dta. A f≈ëz√©s kikapcsol egy hossz√∫ munkanap ut√°n." },
                { text: "Last weekend, I went to the new shopping center in the city. I needed a new pair of shoes for work. There were many sales, so the shops were full of people. I found comfortable black shoes at a good price. I also bought a birthday present for my mother. Shopping can be tiring, but I enjoy finding good deals.", translation: "M√∫lt h√©tv√©g√©n elmentem az √∫j bev√°s√°rl√≥k√∂zpontba a v√°rosban. Sz√ºks√©gem volt egy √∫j p√°r cip≈ëre a munk√°hoz. Sok le√°raz√°s volt, √≠gy az √ºzletek tele voltak emberekkel. Tal√°ltam egy k√©nyelmes fekete cip≈ët j√≥ √°ron. Vettem egy sz√ºlet√©snapi aj√°nd√©kot is az √©desany√°mnak. A v√°s√°rl√°s f√°raszt√≥ lehet, de √©lvezem a j√≥ aj√°nlatok megtal√°l√°s√°t." }
            ],
            'B1': [
                { text: "Dear Sir or Madam, I am writing to complain about the service at your restaurant. I visited your establishment last Friday with my family. We had to wait forty minutes for a table, even though we had a reservation. Furthermore, the food was cold when it arrived. I hope you will improve your service in the future. Sincerely, Anna Kov√°cs.", translation: "Tisztelt H√∂lgyem/Uram! Az√©rt √≠rok, hogy panaszt tegyek az √©tterm√ºkben tapasztalt kiszolg√°l√°s miatt. M√∫lt p√©nteken l√°togattam el a l√©tes√≠tm√©ny√ºkbe a csal√°dommal. Negyven percet kellett v√°rnunk egy asztalra, annak ellen√©re, hogy volt foglal√°sunk. Tov√°bb√° az √©tel hideg volt, amikor meg√©rkezett. Rem√©lem, a j√∂v≈ëben jav√≠tani fognak a szolg√°ltat√°sukon. √údv√∂zlettel: Kov√°cs Anna." },
                { text: "Living in a big city has both advantages and disadvantages. On the one hand, there are many job opportunities and entertainment options. You can go to theaters, museums, and cinemas easily. On the other hand, the traffic is often terrible, and the air is polluted. It is also more expensive to live in a city than in the countryside.", translation: "A nagyv√°rosi √©letnek vannak el≈ënyei √©s h√°tr√°nyai is. Egyr√©szt sok munkalehet≈ës√©g √©s sz√≥rakoz√°si lehet≈ës√©g van. K√∂nnyen eljuthatsz sz√≠nh√°zakba, m√∫zeumokba √©s mozikba. M√°sr√©szt a forgalom gyakran sz√∂rny≈±, √©s a leveg≈ë szennyezett. V√°rosban √©lni dr√°g√°bb is, mint vid√©ken." },
                { text: "I have been learning English for five years. I think it is very important to speak foreign languages. It helps you when you travel abroad and when you are looking for a job. I try to watch movies in English to improve my listening skills. I also read articles on the internet. My goal is to pass the language exam next year.", translation: "√ñt √©ve tanulok angolul. Szerintem nagyon fontos idegen nyelveket besz√©lni. Seg√≠t, amikor k√ºlf√∂ldre utazol, √©s amikor munk√°t keresel. Pr√≥b√°lok angol nyelv≈± filmeket n√©zni, hogy fejlesszem a hall√°s√©rt√©semet. Cikkeket is olvasok az interneten. A c√©lom, hogy j√∂v≈ëre letegyem a nyelvvizsg√°t." },
                { text: "Learning a new skill requires patience and dedication. Whether it is playing an instrument or speaking a foreign language, practice is essential. I recently started learning how to code. At first, it was very difficult, and I made many mistakes. However, I didn't give up. Now I can create simple programs, and I feel very proud of my progress. Lifelong learning keeps the mind active.", translation: "Egy √∫j k√©szs√©g elsaj√°t√≠t√°sa t√ºrelmet √©s elhivatotts√°got ig√©nyel. Legyen sz√≥ hangszeren j√°tsz√°sr√≥l vagy idegen nyelv besz√©l√©s√©r≈ël, a gyakorl√°s elengedhetetlen. Nemr√©g elkezdtem programozni tanulni. Eleinte nagyon neh√©z volt, √©s sok hib√°t v√©tettem. Azonban nem adtam fel. Most m√°r egyszer≈± programokat tudok k√©sz√≠teni, √©s nagyon b√ºszke vagyok a fejl≈ëd√©semre. Az √©lethosszig tart√≥ tanul√°s akt√≠van tartja az elm√©t." },
                { text: "Maintaining a healthy diet is important for both physical and mental health. I try to cook my own meals using fresh ingredients like vegetables, lean meat, and whole grains. Although I love sweets, I try to limit my sugar intake. On weekends, I enjoy experimenting with new recipes from different cultures. Eating together with family is a great way to relax and talk about our day.", translation: "Az eg√©szs√©ges √©trend fenntart√°sa fontos mind a fizikai, mind a ment√°lis eg√©szs√©g szempontj√°b√≥l. Igyekszem saj√°t magam f≈ëzni friss alapanyagokb√≥l, mint p√©ld√°ul z√∂lds√©gek, sov√°ny h√∫sok √©s teljes ki≈ërl√©s≈± gabon√°k. B√°r szeretem az √©dess√©geket, pr√≥b√°lom korl√°tozni a cukorbevitelemet. H√©tv√©gente √©lvezem az √∫j receptekkel val√≥ k√≠s√©rletez√©st k√ºl√∂nb√∂z≈ë kult√∫r√°kb√≥l. A csal√°ddal val√≥ k√∂z√∂s √©tkez√©s remek m√≥dja a kikapcsol√≥d√°snak √©s a napunk megbesz√©l√©s√©nek." }
            ],
            'B2': [
                { text: "The impact of social media on teenagers is a widely debated topic. While these platforms offer a way to stay connected, they can also lead to anxiety and depression. The pressure to present a perfect life online often makes young people feel inadequate. Moreover, cyberbullying is a serious issue that affects many students. Parents and educators need to work together to teach responsible internet usage.", translation: "A k√∂z√∂ss√©gi m√©dia hat√°sa a tin√©dzserekre sz√©les k√∂rben vitatott t√©ma. B√°r ezek a platformok lehet≈ës√©get k√≠n√°lnak a kapcsolattart√°sra, szorong√°shoz √©s depresszi√≥hoz is vezethetnek. A t√∂k√©letes √©let online bemutat√°s√°nak k√©nyszere miatt a fiatalok gyakran alkalmatlannak √©rzik magukat. R√°ad√°sul az internetes zaklat√°s komoly probl√©ma, amely sok di√°kot √©rint. A sz√ºl≈ëknek √©s a pedag√≥gusoknak egy√ºtt kell m≈±k√∂dni√ºk a felel≈ës internethaszn√°lat megtan√≠t√°sa √©rdek√©ben." },
                { text: "Climate change is arguably the most pressing challenge of our time. Rising global temperatures are causing more frequent and severe weather events, such as hurricanes and droughts. To mitigate these effects, we must transition to renewable energy sources and reduce our carbon footprint. Individual actions, like recycling and using public transport, are important, but systemic change is essential for a sustainable future.", translation: "Az √©ghajlatv√°ltoz√°s vitathatatlanul korunk legs√ºrget≈ëbb kih√≠v√°sa. A glob√°lis h≈ëm√©rs√©klet emelked√©se gyakoribb √©s s√∫lyosabb id≈ëj√°r√°si esem√©nyeket okoz, p√©ld√°ul hurrik√°nokat √©s asz√°lyokat. E hat√°sok m√©rs√©kl√©se √©rdek√©ben √°t kell t√©rn√ºnk a meg√∫jul√≥ energiaforr√°sokra, √©s cs√∂kkenten√ºnk kell a sz√©nl√°bnyomunkat. Az egy√©ni cselekv√©sek, mint az √∫jrahasznos√≠t√°s √©s a t√∂megk√∂zleked√©s haszn√°lata fontosak, de a rendszerszint≈± v√°ltoz√°s elengedhetetlen a fenntarthat√≥ j√∂v≈ëh√∂z." },
                { text: "Remote work has become increasingly popular in recent years. For many employees, the flexibility to work from home is a major benefit. It saves time on commuting and allows for a better work-life balance. However, some argue that it reduces collaboration and makes it harder to separate professional and personal life. Companies are now exploring hybrid models to combine the best of both worlds.", translation: "A t√°vmunka egyre n√©pszer≈±bb√© v√°lt az elm√∫lt √©vekben. Sok munkav√°llal√≥ sz√°m√°ra az otthoni munkav√©gz√©s rugalmass√°ga jelent≈ës el≈ëny. Id≈ët takar√≠t meg az ing√°z√°son, √©s jobb munka-mag√°n√©let egyens√∫lyt tesz lehet≈ëv√©. Egyesek azonban √∫gy v√©lik, hogy cs√∂kkenti az egy√ºttm≈±k√∂d√©st, √©s megnehez√≠ti a szakmai √©s a mag√°n√©let sz√©tv√°laszt√°s√°t. A v√°llalatok most hibrid modelleket vizsg√°lnak, hogy √∂tv√∂zz√©k a k√©t vil√°g legjobbjait." },
                { text: "The fashion industry has a significant impact on the environment, a fact that many consumers are beginning to realize. Fast fashion encourages people to buy cheap clothes and discard them quickly, leading to massive waste. To combat this, I have started building a capsule wardrobe with high-quality, timeless pieces. I also enjoy thrift shopping, which is both sustainable and allows for a unique personal style. Dressing ethically is becoming just as important as dressing elegantly.", translation: "A divatipar jelent≈ës hat√°ssal van a k√∂rnyezetre, amit sok fogyaszt√≥ kezd felismerni. A 'fast fashion' arra √∂szt√∂nzi az embereket, hogy olcs√≥ ruh√°kat v√°s√°roljanak √©s gyorsan dobj√°k ki ≈ëket, ami hatalmas hullad√©khoz vezet. Ennek lek√ºzd√©s√©re elkezdtem egy kapszulagardr√≥b √©p√≠t√©s√©t kiv√°l√≥ min≈ës√©g≈±, id≈ët√°ll√≥ darabokb√≥l. Szeretek haszn√°ltruha-boltban is v√°s√°rolni, ami fenntarthat√≥ √©s egyedi szem√©lyes st√≠lust tesz lehet≈ëv√©. Az etikus √∂lt√∂zk√∂d√©s kezd ugyanolyan fontoss√° v√°lni, mint az eleg√°ns √∂lt√∂zk√∂d√©s." }
            ],
            'C1': [
                { text: "The ubiquity of social media has transformed how people communicate, consume news and mobilise politically; yet it has also generated harms‚Äîmisinformation, targeted manipulation and opacity around algorithms. Given the social and economic power wielded by a handful of platforms, there is a compelling argument for government regulation. However, regulation must be carefully designed to protect free expression and innovation while addressing demonstrable harms.", translation: "A k√∂z√∂ss√©gi m√©dia minden√ºtt jelenval√≥s√°ga √°talak√≠totta az emberek kommunik√°ci√≥j√°t, h√≠rfogyaszt√°s√°t √©s politikai mozg√≥s√≠t√°s√°t; ugyanakkor k√°rokat is okozott ‚Äì f√©lret√°j√©koztat√°st, c√©lzott manipul√°ci√≥t √©s az algoritmusok √°tl√°thatatlans√°g√°t. Tekintettel a n√©h√°ny platform √°ltal gyakorolt t√°rsadalmi √©s gazdas√°gi hatalomra, nyom√≥s √©rv sz√≥l a korm√°nyzati szab√°lyoz√°s mellett. A szab√°lyoz√°st azonban gondosan kell megtervezni, hogy v√©dje a v√©lem√©nynyilv√°n√≠t√°s szabads√°g√°t √©s az innov√°ci√≥t, mik√∂zben kezeli a bizony√≠that√≥ k√°rokat." },
                { text: "First, regulation is justified because certain market failures and negative externalities are not resolved by market forces alone. Platforms benefit from network effects and economies of scale that entrench market dominance, reducing incentives to moderate content responsibly or to be transparent about ad-targeting practices. Without oversight, users and even democratic institutions can be damaged by unchecked misinformation campaigns and opaque data practices.", translation: "El≈ësz√∂r is, a szab√°lyoz√°s indokolt, mert bizonyos piaci kudarcokat √©s negat√≠v extern√°li√°kat a piaci er≈ëk √∂nmagukban nem oldanak meg. A platformok profit√°lnak a h√°l√≥zati hat√°sokb√≥l √©s a m√©retgazdas√°goss√°gb√≥l, amelyek megszil√°rd√≠tj√°k a piaci dominanci√°t, cs√∂kkentve a tartalom felel≈ës moder√°l√°s√°ra vagy a hirdet√©sc√©lz√°si gyakorlatok √°tl√°that√≥s√°g√°ra vonatkoz√≥ √∂szt√∂nz≈ëket. Fel√ºgyelet n√©lk√ºl a felhaszn√°l√≥k, s≈ët a demokratikus int√©zm√©nyek is s√©r√ºlhetnek az ellen≈ërizetlen f√©lret√°j√©koztat√°si kamp√°nyok √©s az √°tl√°thatatlan adatkezel√©si gyakorlatok miatt." }
            ],
            'C2': [
                { text: "Demographic ageing‚Äîthe rising proportion of elderly people within a population‚Äîpresents complex cultural and economic challenges for developed countries. While longer life expectancy is a triumph of public health and living standards, ageing populations reshape labour markets, public finances and social norms. Policymakers must therefore formulate integrated strategies that maintain fiscal sustainability, support intergenerational equity and harness the opportunities created by an ageing society.", translation: "A demogr√°fiai el√∂reged√©s ‚Äì az id≈ësek ar√°ny√°nak n√∂veked√©se a n√©pess√©gen bel√ºl ‚Äì √∂sszetett kultur√°lis √©s gazdas√°gi kih√≠v√°sokat jelent a fejlett orsz√°gok sz√°m√°ra. B√°r a hosszabb v√°rhat√≥ √©lettartam a k√∂zeg√©szs√©g√ºgy √©s az √©letsz√≠nvonal diadala, az el√∂reged≈ë n√©pess√©g √°tform√°lja a munkaer≈ëpiacokat, az √°llamh√°ztart√°st √©s a t√°rsadalmi norm√°kat. A politikai d√∂nt√©shoz√≥knak ez√©rt olyan integr√°lt strat√©gi√°kat kell kidolgozniuk, amelyek fenntartj√°k a k√∂lts√©gvet√©si fenntarthat√≥s√°got, t√°mogatj√°k a gener√°ci√≥k k√∂z√∂tti m√©lt√°nyoss√°got, √©s kiakn√°zz√°k az el√∂reged≈ë t√°rsadalom √°ltal teremtett lehet≈ës√©geket." },
                { text: "Economically, an ageing population affects both the supply and demand sides. On the supply side, a declining working-age population can reduce labour availability and slow potential growth. Employers in many sectors already report shortages of skilled and semi-skilled workers, which may push up wages and production costs, particularly in labour-intensive industries such as healthcare and construction. On the demand side, consumption patterns shift: older cohorts tend to spend more on health and housing adaptations and less on durable goods.", translation: "Gazdas√°gilag az el√∂reged≈ë n√©pess√©g mind a k√≠n√°lati, mind a keresleti oldalt √©rinti. A k√≠n√°lati oldalon a cs√∂kken≈ë munkak√©pes kor√∫ n√©pess√©g cs√∂kkentheti a munkaer≈ë rendelkez√©sre √°ll√°s√°t √©s lass√≠thatja a potenci√°lis n√∂veked√©st. Sok √°gazatban a munkaad√≥k m√°r most is szakk√©pzett √©s betan√≠tott munk√°sok hi√°ny√°r√≥l sz√°molnak be, ami felhajthatja a b√©reket √©s a termel√©si k√∂lts√©geket, k√ºl√∂n√∂sen a munkaer≈ë-ig√©nyes ipar√°gakban, mint p√©ld√°ul az eg√©szs√©g√ºgy √©s az √©p√≠t≈ëipar. A keresleti oldalon a fogyaszt√°si szok√°sok megv√°ltoznak: az id≈ësebb koroszt√°lyok hajlamosak t√∂bbet k√∂lteni eg√©szs√©g√ºgyre √©s lakhat√°si √°talak√≠t√°sokra, √©s kevesebbet tart√≥s fogyaszt√°si cikkekre." }
            ]
        };

        const sentenceDatabase = {
            'A1': [
                "I like apples.", "My name is Peter.", "The cat is black.", "I have a dog.", "She is my sister.",
                "The sun is hot.", "I go to school.", "This is a book.", "He is happy.", "We are friends.",
                "The sky is blue.", "I drink milk every day.", "She has a red pen.", "We live in a big city.",
                "He plays football on Mondays.", "My father is a doctor.", "They are at home.", "The dog is under the table.",
                "I want a new bike.", "It is cold today.", "My mother cooks lunch.", "The bird sings a song.",
                "I see a green car.", "She likes chocolate cake.", "We walk to the park.", "The flower is beautiful.",
                "He reads a book.", "I have two brothers.", "The water is warm.", "They speak English.",
                "The cat sleeps on the bed.", "I like to eat pizza.", "She plays with her doll.", "We go to the park.", "He has a blue car.",
                "The dog runs fast.", "My sister is tall.", "I drink water.", "They are happy.", "The sun is yellow."
            ],
            'A2': [
                "I went to the cinema yesterday.", "She is taller than me.", "We are watching TV now.", 
                "Have you ever been to London?", "I did not see him.", "My mother is cooking dinner.",
                "He was reading a book.", "They are playing football.", "I will buy a new car.", "She can swim very well.",
                "I am going to visit my grandma.", "Did you see the movie last night?", "She was sleeping when I arrived.",
                "This house is bigger than yours.", "We will travel to Spain next summer.", "He has already finished his homework.",
                "I was not hungry so I did not eat.", "Are you listening to me?", "They were walking in the forest.",
                "She bought a beautiful dress yesterday.", "I have never eaten sushi before.", "The weather will be sunny tomorrow.",
                "He is the fastest runner in the school.", "We are having a party on Saturday.", "She did not like the food.",
                "I was working all day yesterday.", "Have you seen my keys anywhere?", "They are going to buy a new house.",
                "He is more intelligent than his brother.", "I will call you later.",
                "I bought a new shirt yesterday.", "She is going to the market.", "We have lived here for two years.", "He was watching TV when I called.", "They will visit us next week.",
                "Have you ever seen a ghost?", "I am taller than my brother.", "She does not like coffee.", "We were playing in the garden.", "He has already eaten lunch."
            ],
            'B1': [
                "I have lived here for ten years.", "If it rains we will stay at home.", "I look forward to seeing you.",
                "This is the book which I bought.", "He stopped smoking last year.", "I used to play tennis.",
                "She asked me if I could help.", "The car is being repaired.", "I have never been to Paris.", "You should study harder.",
                "I have been waiting for you for an hour.", "If I were you I would tell the truth.", "The letter was written by my friend.",
                "She said that she was tired.", "You must not smoke in this room.", "I enjoy reading books in my free time.",
                "He managed to fix the car by himself.", "We might go to the beach if it is sunny.", "I have not seen him since last week.",
                "The house was built in nineteen ninety.", "She asked me where I lived.", "I would have called you if I had known.",
                "You ought to apologize to her.", "He is interested in learning history.", "The problem has been solved recently.",
                "I regret not studying harder for the exam.", "She is capable of doing great things.", "We are looking forward to the holiday.",
                "It is important to eat healthy food.", "I wish I had more time.",
                "If I had money I would travel.", "She asked me where I was going.", "I have been working here since twenty ten.", "The book was written by a famous author.", "You should have told me earlier.",
                "I look forward to hearing from you.", "He managed to finish the project on time.", "Unless you hurry you will miss the bus.", "I used to live in London.", "She is interested in learning Spanish."
            ],
            'B2': [
                "He is believed to be rich.", "Had I known I would have helped.", "Not only was he late but he also forgot his book.",
                "It is high time we went home.", "Despite the rain we went out.", "I would rather you did not smoke.",
                "No sooner had I arrived than he left.", "She is accused of stealing the money.", "It is likely to rain tomorrow.", "He is said to be a genius.",
                "Never have I seen such a beautiful sunset.", "It was Mary who solved the problem.", "Under no circumstances should you open this door.",
                "Little did he know about the surprise.", "She is thought to be the best candidate.", "I wish I had not said that to him.",
                "Had he studied harder he would have passed.", "Not until yesterday did I realize the truth.", "It is essential that he be present at the meeting.",
                "She denied having stolen the jewelry.", "Only by working hard can you succeed.", "The more you practice the better you become.",
                "He acts as if he were the boss.", "Suppose you won the lottery what would you do?", "It is about time we started the project.",
                "Rarely do we see such talent.", "She objected to being treated like a child.", "Having finished his work he went home.",
                "Whatever you do do not give up.", "Should you need any help please let me know.",
                "Had I known I would have come.", "It is high time we left.", "She is accused of lying to the police.", "Not only did he win but he also set a record.", "I would rather you stayed home.",
                "Despite the rain we went for a walk.", "He is believed to be innocent.", "No sooner had I arrived than it started raining.", "It is essential that he be informed.", "She denied having seen the accident."
            ],
            'C1': [
                "Not only did he win the competition but he also broke the record.", "Had I known about the meeting I would have attended.",
                "The government is considering implementing stricter regulations.", "It is vital that we address the issue immediately.",
                "She is believed to be the best candidate for the job.", "Seldom have I seen such a beautiful painting.",
                "Under no circumstances should you open this door.", "I would rather you did not smoke in here.",
                "By the time you arrive I will have finished the work.", "He was so tired that he fell asleep immediately.",
                "Only when I arrived home did I realize I had lost my keys.", "It is essential that everyone be informed about the changes.",
                "Seldom have I seen such a mess.", "Under no circumstances should you touch this.", "Had it not been for your help I would have failed.", "Little did she know what was coming.", "Whatever happens I will stand by you.",
                "Be that as it may I still disagree.", "Only after checking did I realize my mistake.", "Were you to ask me I would say yes.", "Scarcely had we started when the lights went out.", "Should you need assistance please call me."
            ],
            'C2': [
                "Scarcely had the ceremony begun when the rain started falling.", "It is imperative that the committee reach a consensus immediately.",
                "Under no circumstances are you to reveal this information.", "Little did he know that his life was about to change forever.",
                "Were it not for your assistance I would not have succeeded.", "Such was the force of the storm that trees were uprooted.",
                "No sooner had I sat down than the phone rang.", "Whatever happens I will always support you.",
                "Should you require any further information please do not hesitate to contact me.", "Had it not been for the quick reaction of the driver the accident would have been fatal.",
                "Not for a moment did I imagine that we would win the lottery.", "Strange as it may seem I actually enjoy working on weekends.",
                "Such was the noise that we could not hear.", "Were it not for his quick thinking we would be dead.", "Hardly had I entered the room when the phone rang.", "Not for a moment did I doubt his integrity.", "Strange as it may seem I actually like it.",
                "Should you require further information do not hesitate to ask.", "Whatever the consequences I must speak the truth.", "Had I but known the truth I would have acted differently.", "Little did they realize the danger they were in.", "So great was his anger that he could not speak."
            ]
        };

        let currentQuestions = [];
        let currentIndex = 0;
        let score = 0;
        let timerInterval;
        let timeLimit = 30; // m√°sodperc
        let currentLevel = "";
        let wrongAnswers = [];
        let isRetry = false;
        let globalTimerInterval;
        let questionsAttempted = 0;
        
        let readingTimerInterval;
        let currentReadingLevel = "";
        let availableReadingIndices = [];
        
        let currentEnglishText = "";
        let recognition;
        let isListening = false;

        let currentSentenceList = [];
        let currentSentenceIndex = 0;
        let currentTargetWords = [];
        let currentPoolWords = [];
        let availableSentenceIndices = [];
        let currentCorrectSentence = "";

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function startLevel(level) {
            const isHardMode = document.getElementById('hard-mode').checked;
            const sessionDuration = parseInt(document.getElementById('session-duration').value);
            timeLimit = isHardMode ? 10 : 30;
            currentLevel = level;

            // Biztons√°gos adatbet√∂lt√©s, ha esetleg hi√°nyozna egy szint
            currentQuestions = database[level] ? [...database[level]] : [];
            if (currentQuestions.length === 0) {
                alert("Ez a szint m√©g nem el√©rhet≈ë vagy hiba t√∂rt√©nt a bet√∂lt√©skor.");
                return;
            }
            
            shuffleArray(currentQuestions);
            currentIndex = 0;
            score = 0;
            questionsAttempted = 0;
            wrongAnswers = [];
            isRetry = false;
            
            if (sessionDuration > 0) {
                document.getElementById('global-timer-wrapper').classList.remove('hidden');
                startGlobalTimer(sessionDuration);
            } else {
                document.getElementById('global-timer-wrapper').classList.add('hidden');
            }

            showScreen('quiz');
            document.getElementById('level-title').innerText = level + " Szint";
            loadQuestion();
        }

        function startGlobalTimer(duration) {
            clearInterval(globalTimerInterval);
            let timeLeft = duration;
            updateGlobalTimerDisplay(timeLeft);
            
            globalTimerInterval = setInterval(() => {
                timeLeft--;
                updateGlobalTimerDisplay(timeLeft);
                if (timeLeft <= 0) {
                    clearInterval(globalTimerInterval);
                    finishSession(true);
                }
            }, 1000);
        }

        function updateGlobalTimerDisplay(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            document.getElementById('global-timer').innerText = `${m}:${s}`;
        }

        function loadQuestion() {
            startTimer();
            const data = currentQuestions[currentIndex];
            document.getElementById('q-num').innerText = currentIndex + 1 + " / " + currentQuestions.length;
            document.getElementById('score-display').innerText = score;
            document.getElementById('question-text').innerText = data.q;
            document.getElementById('feedback').innerText = "";
            document.getElementById('next-btn').classList.add('hidden');
            
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            
            // V√°laszlehet≈ës√©gek indexeinek kever√©se, hogy a gombok sorrendje is v√©letlenszer≈± legyen
            const indices = data.options.map((_, i) => i);
            shuffleArray(indices);

            indices.forEach(idx => {
                const opt = data.options[idx];
                const btn = document.createElement('button');
                btn.className = 'btn btn-option';
                btn.innerText = opt;
                btn.onclick = () => checkAnswer(idx, data.a, btn);
                container.appendChild(btn);
            });
        }

        function startTimer() {
            clearInterval(timerInterval);
            let timeLeft = timeLimit;
            document.getElementById('timer').innerText = timeLeft;
            
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').innerText = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    handleTimeout();
                }
            }, 1000);
        }

        function handleTimeout() {
            const buttons = document.querySelectorAll('.btn-option');
            buttons.forEach(b => b.disabled = true);
            document.getElementById('feedback').innerText = "Lej√°rt az id≈ë! ‚è∞ A helyes: " + currentQuestions[currentIndex].options[currentQuestions[currentIndex].a];
            document.getElementById('feedback').className = "wrong";
            document.getElementById('next-btn').classList.remove('hidden');
            questionsAttempted++;
            wrongAnswers.push(currentQuestions[currentIndex]);
        }

        function speakCurrentQuestion() {
            if ('speechSynthesis' in window) {
                const text = currentQuestions[currentIndex].q.replace(/___/g, "blank");
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                window.speechSynthesis.cancel(); 
                window.speechSynthesis.speak(utterance);
            }
        }

        function checkAnswer(selected, correct, btnElement) {
            clearInterval(timerInterval);
            const buttons = document.querySelectorAll('.btn-option');
            buttons.forEach(b => b.disabled = true); // Gombok letilt√°sa
            questionsAttempted++;

            if (selected === correct) {
                score++;
                document.getElementById('score-display').innerText = score;
                btnElement.style.backgroundColor = '#4CAF50';
                btnElement.style.color = 'white';
                document.getElementById('feedback').innerText = "Helyes v√°lasz! üéâ";
                document.getElementById('feedback').className = "correct";
            } else {
                btnElement.style.backgroundColor = '#f44336';
                btnElement.style.color = 'white';
                document.getElementById('feedback').innerText = "Sajnos nem. A helyes: " + currentQuestions[currentIndex].options[correct];
                document.getElementById('feedback').className = "wrong";
                wrongAnswers.push(currentQuestions[currentIndex]);
            }
            document.getElementById('next-btn').classList.remove('hidden');
        }

        function nextQuestion() {
            currentIndex++;
            if (currentIndex < currentQuestions.length) {
                loadQuestion();
            } else {
                finishSession(false);
            }
        }

        function finishSession(timeRanOut) {
            clearInterval(timerInterval);
            clearInterval(globalTimerInterval);
            
            if (!isRetry) {
                saveResult(currentLevel, score, questionsAttempted);
            }
            
            const percentage = questionsAttempted > 0 ? Math.round((score / questionsAttempted) * 100) : 0;
            let msg = timeRanOut ? "Lej√°rt az id≈ë! ‚è∞\n\n" : "Gyakorl√°s v√©ge! üéâ\n\n";
            
            msg += `Megoldott feladatok: ${questionsAttempted}\n`;
            msg += `Helyes v√°laszok: ${score}\n`;
            msg += `Eredm√©ny: ${percentage}%\n`;
            
            if (percentage === 100 && questionsAttempted > 0) msg += "T√∂k√©letes! üèÜ";
            else if (percentage >= 80) msg += "Kiv√°l√≥! üåü";
            else if (percentage >= 50) msg += "J√≥ munka! üëç";
            else if (questionsAttempted > 0) msg += "Gyakorolj m√©g! üí™";

            if (wrongAnswers.length > 0 && !timeRanOut) {
                msg += "\n\nSzeretn√©d √∫jra megpr√≥b√°lni azokat a k√©rd√©seket, amiket elrontott√°l?";
                if (confirm(msg)) {
                    isRetry = true;
                    currentQuestions = [...wrongAnswers];
                    wrongAnswers = [];
                    currentIndex = 0;
                    score = 0;
                    questionsAttempted = 0;
                    document.getElementById('level-title').innerText = currentLevel + " Szint (Hibajav√≠t√°s)";
                    loadQuestion();
                    return;
                }
            } else {
                alert(msg);
            }
            showMenu();
        }

        function showMenu() {
            showScreen('menu');
            clearInterval(globalTimerInterval); // Ezt k√ºl√∂n is le kell √°ll√≠tani, mert a showScreen nem kezeli a glob√°lis id≈ëz√≠t≈ët
        }

        // Show custom task sections (C1 / C2)
        function showTasks(id) {
            clearInterval(timerInterval);
            if ('speechSynthesis' in window) window.speechSynthesis.cancel();
            document.getElementById('quiz').classList.add('hidden');
            document.getElementById('reading-practice').classList.add('hidden');
            document.getElementById('vocabulary-view').classList.add('hidden');
            document.getElementById('menu').classList.add('hidden');
            const el = document.getElementById(id);
            if (el) el.classList.remove('hidden');
            clearInterval(readingTimerInterval);
        }

        // Olvas√°s funkci√≥k
        function startReading(level) {
            currentReadingLevel = level;
            availableReadingIndices = []; // Lista alaphelyzetbe √°ll√≠t√°sa √∫j szint ind√≠t√°sakor
            showScreen('reading-practice');
            document.getElementById('reading-level-title').innerText = level + " Szint - Olvas√°s";
            loadNewReadingText();
            document.getElementById('pronunciation-feedback').style.display = 'none';
        }

        function loadNewReadingText() {
            clearInterval(readingTimerInterval);
            document.getElementById('reading-progress').style.width = '0%';
            document.getElementById('start-reading-btn').classList.remove('hidden');
            document.getElementById('new-text-btn').classList.add('hidden');
            
            const texts = readingDatabase[currentReadingLevel];
            
            // Ha elfogytak a sz√∂vegek (vagy most kezdj√ºk), t√∂lts√ºk fel a list√°t az indexekkel
            if (availableReadingIndices.length === 0) {
                availableReadingIndices = texts.map((_, i) => i);
            }

            // V√©letlenszer≈± v√°laszt√°s a m√©g nem haszn√°lt indexek k√∂z√ºl, majd elt√°vol√≠t√°s
            const randIdx = Math.floor(Math.random() * availableReadingIndices.length);
            const textIndex = availableReadingIndices[randIdx];
            availableReadingIndices.splice(randIdx, 1);
            
            const randomItem = texts[textIndex];
            
            const englishText = randomItem.text;
            currentEnglishText = englishText;
            const hungarianText = randomItem.translation;

            const contentDiv = document.getElementById('reading-content');
            contentDiv.innerHTML = `
                <div id="reading-text-en">${englishText}</div>
                <div style="margin-top: 20px; border-top: 1px solid #ddd; padding-top: 15px;">
                    <button id="trans-btn" class="btn-option" style="width: auto; font-size: 0.9em; padding: 8px 15px;" onclick="toggleTranslation()">Ford√≠t√°s megjelen√≠t√©se üëÅÔ∏è</button>
                    <div id="reading-text-hu" class="hidden" style="margin-top: 10px; color: #444; font-style: italic;">${hungarianText}</div>
                </div>
            `;
        }

        function toggleTranslation() {
            const huText = document.getElementById('reading-text-hu');
            const btn = document.getElementById('trans-btn');
            if (huText.classList.contains('hidden')) {
                huText.classList.remove('hidden');
                btn.innerText = "Ford√≠t√°s elrejt√©se üôà";
            } else {
                huText.classList.add('hidden');
                btn.innerText = "Ford√≠t√°s megjelen√≠t√©se üëÅÔ∏è";
            }
        }

        function startReadingTimer() {
            document.getElementById('start-reading-btn').classList.add('hidden');
            let timeLeft = 60;
            const totalTime = 60;
            const progressBar = document.getElementById('reading-progress');
            
            progressBar.style.width = '0%';
            
            readingTimerInterval = setInterval(() => {
                timeLeft -= 0.1;
                const percentage = ((totalTime - timeLeft) / totalTime) * 100;
                progressBar.style.width = percentage + '%';
                
                if (timeLeft <= 0) {
                    clearInterval(readingTimerInterval);
                    document.getElementById('new-text-btn').classList.remove('hidden');
                }
            }, 100);
        }

        function speakReadingText() {
            if ('speechSynthesis' in window) {
                const enDiv = document.getElementById('reading-text-en');
                const text = enDiv ? enDiv.innerText : document.getElementById('reading-content').innerText;
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(utterance);
            }
        }

        function togglePronunciation() {
            const feedbackDiv = document.getElementById('pronunciation-feedback');
            const btn = document.getElementById('pronunciation-btn');

            if (isListening) {
                if (recognition) recognition.stop();
                isListening = false;
                btn.innerText = "üé§ Kiejt√©s";
                return;
            }

            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert("A b√∂ng√©sz≈ëd nem t√°mogatja a hangfelismer√©st (pr√≥b√°ld Chrome-ban asztali g√©pen vagy Androidon).");
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.continuous = true;
            recognition.interimResults = true;

            feedbackDiv.style.display = 'block';
            feedbackDiv.innerHTML = "<i>Figyelek... Olvasd fel a sz√∂veget!</i>";
            
            let finalTranscript = '';

            recognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript + ' ';
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                
                const currentSpoken = finalTranscript + interimTranscript;
                const accuracy = calculateAccuracy(currentSpoken, currentEnglishText);
                
                feedbackDiv.innerHTML = `
                    <div style="color: #555; margin-bottom: 5px;">Hallott sz√∂veg:</div>
                    <div style="font-style: italic; margin-bottom: 10px; color: #333;">${currentSpoken}</div>
                    <div style="font-weight: bold; color: ${accuracy > 60 ? '#4CAF50' : '#FF9800'}">Becs√ºlt egyez√©s: ${accuracy}%</div>
                `;
            };

            recognition.onerror = (event) => {
                console.log("Speech recognition error", event.error);
                if (event.error === 'not-allowed') {
                    alert("K√©rlek enged√©lyezd a mikrofon haszn√°lat√°t!");
                    isListening = false;
                    btn.innerText = "üé§ Kiejt√©s";
                }
            };
            
            recognition.onend = () => {
                if (isListening) {
                    isListening = false;
                    btn.innerText = "üé§ Kiejt√©s";
                }
            };

            recognition.start();
            isListening = true;
            btn.innerText = "‚èπÔ∏è Le√°ll√≠t√°s";
        }

        function calculateAccuracy(spoken, original) {
            const normalize = text => text.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").split(/\s+/).filter(w => w.length > 0);
            const spokenWords = normalize(spoken);
            const originalWords = normalize(original);
            
            if (originalWords.length === 0) return 0;

            let matches = 0;
            let originalMap = {};
            originalWords.forEach(w => originalMap[w] = (originalMap[w] || 0) + 1);

            spokenWords.forEach(w => {
                if (originalMap[w] && originalMap[w] > 0) {
                    matches++;
                    originalMap[w]--;
                }
            });

            return Math.round((matches / originalWords.length) * 100);
        }

        // Mondat√©p√≠t≈ë funkci√≥k
        function startSentenceBuilder(level) {
            currentLevel = level;
            availableSentenceIndices = []; // Lista alaphelyzetbe √°ll√≠t√°sa
            
            showScreen('sentence-builder');
            document.getElementById('sb-level-title').innerText = level + " Szint - Mondat√©p√≠t≈ë";
            
            loadSentenceTask();
        }

        function loadSentenceTask() {
            const sentences = sentenceDatabase[currentLevel];
            
            // Ha elfogytak a mondatok, t√∂lts√ºk fel a list√°t
            if (availableSentenceIndices.length === 0) {
                availableSentenceIndices = sentences.map((_, i) => i);
            }

            const randIdx = Math.floor(Math.random() * availableSentenceIndices.length);
            const sentenceIndex = availableSentenceIndices[randIdx];
            availableSentenceIndices.splice(randIdx, 1);
            
            const sentence = sentences[sentenceIndex];
            currentCorrectSentence = sentence;
            
            const words = sentence.split(' ');
            
            currentPoolWords = [...words];
            shuffleArray(currentPoolWords);
            currentTargetWords = [];
            
            renderSentenceBuilder();
            document.getElementById('sb-feedback').innerText = "";
            document.getElementById('sb-feedback').className = "";
            document.getElementById('sb-next-btn').classList.add('hidden');
        }

        function renderSentenceBuilder() {
            const targetDiv = document.getElementById('sb-target');
            const poolDiv = document.getElementById('sb-pool');
            
            targetDiv.innerHTML = '';
            poolDiv.innerHTML = '';
            
            currentTargetWords.forEach((word, index) => {
                const chip = document.createElement('div');
                chip.className = 'word-chip';
                chip.innerText = word;
                chip.onclick = () => moveWordToPool(index);
                targetDiv.appendChild(chip);
            });
            
            currentPoolWords.forEach((word, index) => {
                const chip = document.createElement('div');
                chip.className = 'word-chip';
                chip.innerText = word;
                chip.onclick = () => moveWordToTarget(index);
                poolDiv.appendChild(chip);
            });
        }

        function moveWordToTarget(poolIndex) {
            const word = currentPoolWords[poolIndex];
            currentPoolWords.splice(poolIndex, 1);
            currentTargetWords.push(word);
            renderSentenceBuilder();
        }

        function moveWordToPool(targetIndex) {
            const word = currentTargetWords[targetIndex];
            currentTargetWords.splice(targetIndex, 1);
            currentPoolWords.push(word);
            renderSentenceBuilder();
        }

        function resetSentenceTask() {
            const sentence = currentCorrectSentence;
            const words = sentence.split(' ');
            currentPoolWords = [...words];
            shuffleArray(currentPoolWords);
            currentTargetWords = [];
            renderSentenceBuilder();
            document.getElementById('sb-feedback').innerText = "";
            document.getElementById('sb-feedback').className = "";
        }

        function checkSentenceOrder() {
            const userSentence = currentTargetWords.join(' ');
            const correctSentence = currentCorrectSentence;
            
            if (userSentence === correctSentence) {
                document.getElementById('sb-feedback').innerText = "Helyes! üéâ";
                document.getElementById('sb-feedback').className = "correct";
                document.getElementById('sb-next-btn').classList.remove('hidden');
            } else {
                document.getElementById('sb-feedback').innerText = "Nem j√≥ sorrend. Pr√≥b√°ld √∫jra!";
                document.getElementById('sb-feedback').className = "wrong";
            }
        }

        function showSentenceSolution() {
            const correctSentence = currentCorrectSentence;
            const feedbackEl = document.getElementById('sb-feedback');
            feedbackEl.innerText = `A helyes sorrend: ${correctSentence}`;
            feedbackEl.className = ""; // St√≠lusok vissza√°ll√≠t√°sa
        }

        function speakSentence() {
            if ('speechSynthesis' in window) {
                const text = currentCorrectSentence;
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(utterance);
            }
        }

        function nextSentenceTask() {
            if (availableSentenceIndices.length === 0) {
                alert("Gratul√°lok! Befejezted a mondat√©p√≠t≈ë feladatokat ezen a szinten. A feladatok √∫jraindulnak.");
            }
            loadSentenceTask();
        }

        function showVocabulary() {
            showScreen('vocabulary-view');
            
            const container = document.getElementById('vocab-content');
            container.innerHTML = '';

            for (const level in database) {
                const levelHeader = document.createElement('div');
                levelHeader.className = 'vocab-level-header';
                levelHeader.innerText = level + " Szint";
                container.appendChild(levelHeader);

                const table = document.createElement('table');
                table.className = 'vocab-table';
                table.innerHTML = `<thead><tr><th>K√©rd√©s / Sz√≥</th><th>Helyes v√°lasz</th></tr></thead><tbody></tbody>`;
                const tbody = table.querySelector('tbody');
                
                database[level].forEach(item => {
                    const row = document.createElement('tr');
                    const correctAnswer = item.options[item.a];
                    row.innerHTML = `<td>${item.q}</td><td style="font-weight:bold; color:#2e7d32;">${correctAnswer}</td>`;
                    tbody.appendChild(row);
                });
                container.appendChild(table);
            }
        }

        // K√©perny≈ëv√°lt√≥ seg√©df√ºggv√©ny
        function showScreen(screenId) {
            const screens = ['menu', 'quiz', 'reading-practice', 'sentence-builder', 'vocabulary-view'];
            screens.forEach(id => document.getElementById(id).classList.add('hidden'));
            
            const target = document.getElementById(screenId);
            if (target) {
                target.classList.remove('hidden');
                target.classList.add('fade-in');
            }
            
            // H√°tt√©rfolyamatok le√°ll√≠t√°sa
            clearInterval(timerInterval);
            clearInterval(readingTimerInterval);
            if ('speechSynthesis' in window) window.speechSynthesis.cancel();
        }

        function saveResult(level, score, total) {
            const key = 'angol_tanulo_stats';
            let stats = JSON.parse(localStorage.getItem(key)) || {};
            
            if (!stats[level]) {
                stats[level] = { best: 0, last: 0, total: total };
            }
            
            stats[level].last = score;
            stats[level].total = total; // Friss√≠tj√ºk a k√©rd√©sek sz√°m√°t, ha v√°ltozna
            if (score > stats[level].best) {
                stats[level].best = score;
            }
            
            localStorage.setItem(key, JSON.stringify(stats));
            updateStatsUI();
        }

        function updateStatsUI() {
            const key = 'angol_tanulo_stats';
            const stats = JSON.parse(localStorage.getItem(key)) || {};
            const list = document.getElementById('stats-list');
            list.innerHTML = '';
            
            if (Object.keys(stats).length === 0) {
                list.innerHTML = '<li>M√©g nincs mentett eredm√©ny.</li>';
                return;
            }

            for (const level in stats) {
                const data = stats[level];
                const li = document.createElement('li');
                li.style.marginBottom = '8px';
                li.innerHTML = `<div style="display: flex; justify-content: space-between; align-items: center;"><span style="font-weight: bold; color: #4CAF50;">${level}</span> <span>Legjobb: <b>${data.best}/${data.total}</b> <span style="font-size:0.85em; color:#888;">(Utols√≥: ${data.last})</span></span></div>`;
                list.appendChild(li);
            }
        }

        function clearStats() {
            if(confirm('Biztosan t√∂r√∂lni szeretn√©d az eredm√©nyeket?')) {
                localStorage.removeItem('angol_tanulo_stats');
                updateStatsUI();
            }
        }

        // Inicializ√°l√°s bet√∂lt√©skor
        updateStatsUI();

        // PWA Service Worker √©s Telep√≠t√©s logika
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then((reg) => console.log('Service Worker regisztr√°lva:', reg.scope))
                    .catch((err) => console.log('Service Worker hiba:', err));
            });
        }

        let deferredPrompt;
        const installBtn = document.getElementById('installBtn');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.style.display = 'inline-block';

            installBtn.addEventListener('click', () => {
                installBtn.style.display = 'none';
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('Felhaszn√°l√≥ elfogadta a telep√≠t√©st');
                    }
                    deferredPrompt = null;
                });
            });
        });
    </script>
</body>
</html>